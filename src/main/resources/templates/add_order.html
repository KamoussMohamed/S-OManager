<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Add Order</title>
    <script>
        let selectedProducts = [];

        function addItem() {
            const productSelect = document.getElementById('products');
            const productId = productSelect.value;
            const productName = productSelect.options[productSelect.selectedIndex].text;
            const quantityInput = document.getElementById('quantity');
            const quantity = parseInt(quantityInput.value);

            // Call the function to check stock and add item
            checkStockAndAddItem(productId, productName, quantity);

            quantityInput.value = '';
        }

        function checkStockAndAddItem(productId, productName, quantity) {
            // Find the selected product
            const selectedProduct = document.querySelector('#products [value="' + productId + '"]');
            const stock = parseFloat(selectedProduct.getAttribute('data-stock'));

            // Calculate the total quantity of the product already in the cart
            const totalQuantityInCart = selectedProducts.filter(id => id === productId).length;

            // Check if the total quantity exceeds the available stock
            if (totalQuantityInCart + quantity > stock) {
                alert("Stock insuffisant pour " + productName);
                return; // Exit the function if stock is insufficient
            }

            // Add the product to the selectedProducts array
            for (let i = 0; i < quantity; i++) {
                selectedProducts.push(productId);
            }

            // Update the table
            updateTable();
        }

        function updateTable() {
            const tableBody = document.getElementById('selectedProductsTableBody');
            tableBody.innerHTML = '';

            // Use an object to store products with their quantities
            const productQuantities = {};

            // Calculate the quantities of each product
            selectedProducts.forEach(productId => {
                // If the product already exists, increment the quantity
                if (productQuantities[productId]) {
                    productQuantities[productId]++;
                } else { // Otherwise, initialize the quantity to 1
                    productQuantities[productId] = 1;
                }
            });

            // Display the products with their total quantities
            Object.keys(productQuantities).forEach(productId => {
                const row = document.createElement('tr');
                const nameCell = document.createElement('td');
                const quantityCell = document.createElement('td');

                // Get the product name based on the ID
                const productName = document.querySelector('#products [value="' + productId + '"]').text;

                nameCell.textContent = productName;
                quantityCell.textContent = productQuantities[productId]; // Display the total quantity

                row.appendChild(nameCell);
                row.appendChild(quantityCell);
                tableBody.appendChild(row);
            });
        }

        function submitForm() {
            const form = document.getElementById('orderForm');
            const productsInput = document.createElement('input');
            productsInput.type = 'hidden';
            productsInput.name = 'productsJson';
            productsInput.value = JSON.stringify(selectedProducts);

            form.appendChild(productsInput);
            form.submit();
        }
    </script>
</head>
<body>
<h1>Add Order</h1>
<form id="orderForm" action="/add_orderPost" method="post">
    <div>
        <label for="orderDescription">Order Description:</label>
        <input type="text" id="orderDescription" name="orderDescription" required>
    </div>
    <div>
        <label for="customer">Customer:</label>
        <select id="customer" name="customer">
            <option th:each="cust : ${customers}" th:value="${cust.customerId}" th:text="${cust.name}"></option>
        </select>
    </div>
    <div>
        <label for="products">Select Products:</label>
        <select id="products" name="products">
            <option th:each="prod : ${products}" th:value="${prod.id}" th:text="${prod.productName}" th:attr="data-stock=${prod.quantity}"></option>
        </select>
    </div>
    <div>
        <label for="quantity">Quantity:</label>
        <input type="number" id="quantity" name="quantity" min="1" required>
    </div>
    <button type="button" onclick="addItem()">Add Item</button>
    <button type="button" onclick="submitForm()">Submit</button>
</form>

<h2>Selected Products</h2>
<table border="1">
    <thead>
    <tr>
        <th>Product Name</th>
        <th>Quantity</th>
    </tr>
    </thead>
    <tbody id="selectedProductsTableBody">
    </tbody>
</table>

<a href="/orders">Orders list</a>
</body>
</html>
