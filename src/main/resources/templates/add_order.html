<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Add Order</title>
    <script>
        let selectedProducts = [];

        function addItem() {
            const productSelect = document.getElementById('products');
            const productId = productSelect.value;
            const productName = productSelect.options[productSelect.selectedIndex].text;
            const quantityInput = document.getElementById('quantity');
            const quantity = parseInt(quantityInput.value);

            // Ajouter le produit au tableau selectedProducts
            for (let i = 0; i < quantity; i++) {
                selectedProducts.push(productId);
            }

            updateTable();
            quantityInput.value = '';
        }

        function updateTable() {
            const tableBody = document.getElementById('selectedProductsTableBody');
            tableBody.innerHTML = '';

            // Utiliser un objet pour stocker les produits avec leur quantité
            const productQuantities = {};

            // Calculer les quantités de chaque produit
            selectedProducts.forEach(productId => {
                // Si le produit existe déjà, incrémentez la quantité
                if (productQuantities[productId]) {
                    productQuantities[productId]++;
                } else { // Sinon, initialiser la quantité à 1
                    productQuantities[productId] = 1;
                }
            });

            // Afficher les produits avec leur quantité totale
            Object.keys(productQuantities).forEach(productId => {
                const row = document.createElement('tr');
                const nameCell = document.createElement('td');
                const quantityCell = document.createElement('td');

                // Récupérer le nom du produit basé sur l'ID
                const productName = document.querySelector('#products [value="' + productId + '"]').text;

                nameCell.textContent = productName;
                quantityCell.textContent = productQuantities[productId]; // Afficher la quantité totale

                row.appendChild(nameCell);
                row.appendChild(quantityCell);
                tableBody.appendChild(row);
            });
        }

        function submitForm() {
            const form = document.getElementById('orderForm');
            const productsInput = document.createElement('input');
            productsInput.type = 'hidden';
            productsInput.name = 'productsJson';
            productsInput.value = JSON.stringify(selectedProducts);

            form.appendChild(productsInput);
            form.submit();
        }
    </script>
</head>
<body>
<h1>Add Order</h1>
<form id="orderForm" action="/add_orderPost" method="post">
    <div>
        <label for="orderDescription">Order Description:</label>
        <input type="text" id="orderDescription" name="orderDescription" required>
    </div>
    <div>
        <label for="customer">Customer:</label>
        <select id="customer" name="customer">
            <option th:each="cust : ${customers}" th:value="${cust.customerId}" th:text="${cust.name}"></option>
        </select>
    </div>
    <div>
        <label for="products">Select Products:</label>
        <select id="products" name="products">
            <option th:each="prod : ${products}" th:value="${prod.id}" th:text="${prod.productName}"></option>
        </select>
    </div>
    <div>
        <label for="quantity">Quantity:</label>
        <input type="number" id="quantity" name="quantity" min="1" required>
    </div>
    <button type="button" onclick="addItem()">Add Item</button>
    <button type="button" onclick="submitForm()">Submit</button>
</form>

<h2>Selected Products</h2>
<table border="1">
    <thead>
    <tr>
        <th>Product Name</th>
        <th>Quantity</th>
    </tr>
    </thead>
    <tbody id="selectedProductsTableBody">
    </tbody>
</table>

<a href="/orders">Back to Orders</a>
</body>
</html>
